name: Helm Package and Deploy to GitHub Pages

on:
  push:
    branches:
      - master

jobs:
  update-helm-repo:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Install Helm
      run: |
        curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
        chmod 700 get_helm.sh
        ./get_helm.sh

    - name: Install yq
      run: |
        sudo apt-get update -q
        sudo apt-get install -y yq

    - name: Extract Version from Chart.yaml
      id: chart_version
      run: |
        VERSION=$(yq '.version' helmchart/Chart.yaml)
        echo "Extracted Version: $VERSION"
        echo "VERSION=$VERSION" >> $GITHUB_ENV

    - name: Package Helm Chart
      run: |
        helm package helmchart --destination .

    - name: Generate Helm Repo Index
      run: |
        helm repo index . --url https://miraccan00.github.io/Backend-ArgoCD-WebApp/

    - name: Push Helm Package and Index to gh-pages
      run: |
        git fetch origin gh-pages || git checkout --orphan gh-pages
        git checkout gh-pages

        mv servicename-${{ env.VERSION }}.tgz helmchart/
        mv index.yaml helmchart/
        git add helmchart/*.tgz helmchart/index.yaml

        git commit -m "Updated Helm chart and index for version ${{ env.VERSION }}"
        git push origin gh-pages
